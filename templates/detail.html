<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ name }}</title>
    <!-- import vue-->
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <!-- import Element UI style -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.6/lib/theme-chalk/index.css">
    <!-- import Element UI ui lib -->
    <script src="https://cdn.jsdelivr.net/npm/element-ui@2.15.6/lib/index.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="//unpkg.com/vue@2"></script>
    <script src="//unpkg.com/element-ui"></script>
    <script src="//unpkg.com/element-ui/lib/umd/locale/en.js"></script>
    <!-- import D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- import Socket.IO -->
    <script src="https://cdn.jsdelivr.net/npm/socket.io/dist/socket.io.js"></script>
    <script src="{{ url_for('static', filename='js/commonUtils.js') }}"></script>

    <style>
        .node circle {
            fill: #fff;
            stroke: #000;
            stroke-width: 1.5px;
        }

        text {
            font: 10px sans-serif;
            pointer-events: none;
        }

        .graph-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 40%;
            height: 20%;
            margin: auto;
            border: 1px solid #ccc;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .graph-container img {
            max-width: 100%;
            max-height: 100%;
        }
    </style>
</head>

<body>

<div id="app">
    <el-card>
        <h2><strong>Title:</strong> {{ record.title }}</h2>
        <p><strong>Description:</strong> {{ record.description }}</p>
        <p><strong>Upload Time:</strong> {{ record.created_at }}</p>
        <el-table :data="data.file_urls" style="width: 100%">
            <el-table-column prop="filename" label="File Name"></el-table-column>
            <el-table-column label="Download">
                <template slot-scope="scope">
                    <el-button type="primary" @click="downloadFile(scope.row.file_urls)">Download</el-button>
                </template>
            </el-table-column>
        </el-table>

        <el-button type="danger" @click="confirmDelete">Delete This Record</el-button>

        <!-- Knowledge Graph Visualization -->
        <div id="graph-container">
            <h3>Knowledge Graph</h3>
{#            <div id="graph" style="width: fit-content; height: fit-content; margin-top: 20px;"></div>#}
             <img src="data:image/png;base64,{{ graph }}" alt="Knowledge Graph" style=" margin-top: 20px;">
        </div>

        <el-input v-model="sparqlQuery" type="textarea" placeholder="Enter SPARQL query" rows="6" style="margin-top: 20px;"></el-input>
        <el-button type="success" @click="executeQuery">Execute Query (only for this upload record)</el-button>
        <div v-if="queryResult">
            <el-table :data="queryResult">
                <el-table-column v-for="column in columns" :key="column" :prop="column" :label="column"></el-table-column>
            </el-table>
        </div>


        <el-dialog
            title="Confirm Delete"
            :visible.sync="dialogVisible"
            width="30%"
            @close="dialogVisible = false">
            <span>Are you sure you want to delete this record?</span>
            <span slot="footer" class="dialog-footer">
                <el-button @click="dialogVisible = false">Cancel</el-button>
                <el-button type="primary" @click="deleteRecord">Confirm</el-button>
            </span>
        </el-dialog>

    </el-card>
</div>

</body>

<script>
    new Vue({
        el: '#app',
        data: {
            data: {{ record | tojson | safe}},
            record_id:{{ insert_id | tojson | safe}},
            {#rdf_data:{{ rdf_data | tojson | safe}},#}
            sparqlQuery: 'SELECT * WHERE { ?sub ?pred ?obj .}',
            queryResult: null,
            columns: [],
            dialogVisible: false
        },
        mounted() {
            {#console.log(this.record_id)#}
            {#console.log(this.data)#}
            {#console.log(this.rdf_data)#}

            setCurrentURL("/detail/"+this.record_id)
            this.drawGraph();
        },
        methods: {
            downloadFile(file) {
                window.location.href = `/download/${file}`;
            },


            executeQuery() {
                axios.post(`/sparQL_query_single_record/${this.record_id}`, { query: this.sparqlQuery })
                    .then(response => {
                        console.log(response.data.success)
                        const data = JSON.parse(response.data.success).results.bindings;
                        if (data.length > 0) {
                            this.columns = Object.keys(data[0]);
                        } else {
                            this.columns = [];
                        }
                        this.queryResult = data.map(row => {
                            let result = {};
                            for (let col of this.columns) {
                                result[col] = row[col] ? row[col].value : '';
                            }
                            return result;
                        });
                    })
                    .catch(error => {
                        this.$message.error("Error: "+error.message);
                        this.queryResult = [];
                        console.log("error: "+error.message);
                    });
            },


            confirmDelete() {
                this.dialogVisible = true;
            },
            deleteRecord() {
                axios.get(`/deleteRDF_request/${this.record_id}`)
                    .then(response => {
                        this.$message.success('Record deleted successfully');
                        window.location.href = '/uploadHistory';
                    })
                    .catch(error => {
                        this.$message.error('Error deleting record');
                    });
                this.dialogVisible = false;
            },
            /*
            drawGraph() {
                const width = 960,
                      height = 600;

                const svg = d3.select("#graph").append("svg")
                    .attr("width", width)
                    .attr("height", height);

                const simulation = d3.forceSimulation()
                    .force("link", d3.forceLink().id(d => d.id))
                    .force("charge", d3.forceManyBody().strength(-400))
                    .force("center", d3.forceCenter(width / 2, height / 2));

                const graph = this.parseRDF(this.rdf_data);

                const link = svg.append("g")
                    .attr("class", "links")
                    .selectAll("line")
                    .data(graph.links)
                    .enter().append("line")
                    .attr("class", "link");

                const node = svg.append("g")
                    .attr("class", "nodes")
                    .selectAll("g")
                    .data(graph.nodes)
                    .enter().append("g")
                    .on("mouseover", mouseOver)
                    .on("mouseout", mouseOut);

                node.append("circle")
                    .attr("r", 5)
                    .attr("fill", "blue");

                node.append("text")
                    .attr("x", 6)
                    .attr("y", 3)
                    .text(d => d.id)
                    .style("visibility", "hidden");

                simulation
                    .nodes(graph.nodes)
                    .on("tick", ticked);

                simulation.force("link")
                    .links(graph.links);

                function ticked() {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    node
                        .attr("transform", d => `translate(${d.x},${d.y})`);
                }

                function mouseOver(event, d) {
                    d3.select(this).select("text").style("visibility", "visible");
                }

                function mouseOut(event, d) {
                    d3.select(this).select("text").style("visibility", "hidden");
                }
            },

            parseRDF(rdf_data) {
                const nodes = new Set();
                const links = [];

                rdf_data.forEach(([s, p, o]) => {
                    nodes.add(s);
                    nodes.add(o);
                    links.push({ source: s, target: o, predicate: p });
                });

                return {
                    nodes: Array.from(nodes).map(id => ({ id })),
                    links
                };
            }
             */
        }
    });
    ELEMENT.locale(ELEMENT.lang.en);
</script>
</html>
